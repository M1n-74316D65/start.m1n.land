<!doctype html>
<meta charset="utf-8" />
<meta name="color-scheme" content="dark light" />
<meta name="robots" content="noindex" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#0a0a0a" media="(prefers-color-scheme: dark)" />
<meta
    name="theme-color"
    content="#fafafa"
    media="(prefers-color-scheme: light)"
/>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta
    name="apple-mobile-web-app-status-bar-style"
    content="black-translucent"
/>
<meta name="apple-mobile-web-app-title" content="M1n Startpage" />
<link rel="manifest" href="/manifest.json" />
<link rel="apple-touch-icon" href="/images/favicon-8.png" />
<title>M1n Startpage</title>

<style>
    :root {
        --border-radius: 1rem;
        --color-background: #0a0a0a;
        --color-text-subtle: #666;
        --color-text: #f0f0f0;
        --color-focus: #1a1a1a;
        --color-accent: #84cc16;
        --color-accent-glow: rgba(132, 204, 22, 0.15);
        --font-family:
            'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        --font-size: clamp(15px, 1.5vw, 17px);
        --font-weight-bold: 600;
        --font-weight-normal: 400;
        --letter-spacing: -0.02em;
        --space: 1rem;
        --transition-speed: 250ms;
        --transition-easing: cubic-bezier(0.4, 0, 0.2, 1);
    }

    @media (prefers-color-scheme: light) {
        :root {
            --color-background: #fafafa;
            --color-text-subtle: #737373;
            --color-text: #171717;
            --color-focus: #e5e5e5;
            --color-accent: #65a30d;
            --color-accent-glow: rgba(101, 163, 13, 0.12);
        }
    }
</style>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

<script>
    // Constants
    const SERVICE_WORKER_PATH = '/service-worker.js';
    const SERVICE_WORKER_SCOPE_MSG =
        'ServiceWorker registration successful with scope: ';
    const SERVICE_WORKER_ERROR_MSG = 'ServiceWorker registration failed: ';

    // Service Worker Registration
    function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register(SERVICE_WORKER_PATH).then(
                    (registration) => {
                        console.log(
                            SERVICE_WORKER_SCOPE_MSG,
                            registration.scope
                        );
                    },
                    (error) => {
                        console.log(SERVICE_WORKER_ERROR_MSG, error);
                    }
                );
            });

            // Listen for cache update notifications from service worker
            navigator.serviceWorker.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'CACHE_UPDATED') {
                    console.log('PWA cache updated successfully');
                }
            });
        }
    }

    // PWA Cache Update Function
    function updatePWACache() {
        if (
            'serviceWorker' in navigator &&
            navigator.serviceWorker.controller
        ) {
            navigator.serviceWorker.controller.postMessage({
                type: 'UPDATE_CACHE',
            });
            console.log('PWA cache update requested');
        }
    }

    // Global keyboard event listener for Ctrl+Shift+R
    document.addEventListener('keydown', (event) => {
        if (event.ctrlKey && event.shiftKey && event.key === 'R') {
            event.preventDefault();
            updatePWACache();
        }
    });

    // Configuration
    const CONFIG = {
        commandPathDelimiter: '/',
        commandSearchDelimiter: ' ',
        commandCaseSensitive: false,
        defaultSearchTemplate: 'https://www.google.com/search?q={}',
        openLinksInNewTab: false,
        suggestionLimit: 4,
    };

    // Commands
    const COMMANDS = new Map([
        [
            'M',
            {
                name: 'Mail',
                url: 'https://mail.google.com/',
            },
        ],
        [
            'G',
            {
                name: 'GitHub',
                url: 'https://github.com/',
            },
        ],
        ['V', { name: 'Vercel', url: 'https://vercel.com/dashboard' }],
        [
            'B',
            {
                name: 'Supabase',
                url: 'https://supabase.com/dashboard/projects',
            },
        ],
        ['N', { name: 'Prime Video', url: 'https://www.primevideo.com/' }],
        [
            'A',
            {
                name: 'Audiobooks',
                url: 'https://audio.m1n.land',
            },
        ],
        ['T', { name: 'Twitch', url: 'https://www.twitch.tv' }],
        [
            'Y',
            {
                name: 'YouTube',
                searchTemplate: '/results?search_query={}',
                url: 'https://youtube.com',
            },
        ],
        ['R', { name: 'RSS feed', url: 'https://owl.report/' }],
        ['H', { name: 'Hacker News', url: 'https://news.ycombinator.com' }],
        [
            'P',
            {
                name: 'Pastebin',
                url: 'https://paste.m1n.land/',
            },
        ],
        ['O', { name: 'Cloudflare', url: 'https://dash.cloudflare.com' }],
        ['F', { name: 'Fabric', url: 'https://fabric.so/' }],
        ['I', { name: 'Gemini', url: 'https://gemini.google.com'}],
        [
            'S',
            {
                name: 'Server',
                url: 'http://192.168.1.139:8006',
            },
        ],
        ['1', { name: 'M1n', url: 'https://m1n.land/' }],
    ]);

    // Hacker News API functionality
    window.HackerNewsAPI = class HackerNewsAPI {
        static async fetchTopStories(limit = 10) {
            try {
                const response = await fetch(
                    'https://hacker-news.firebaseio.com/v0/topstories.json'
                );
                const storyIds = await response.json();
                const topStoryIds = storyIds.slice(0, limit);

                const storyPromises = topStoryIds.map((id) =>
                    this.fetchStory(id)
                );
                const stories = await Promise.all(storyPromises);

                return stories.filter((story) => story !== null);
            } catch (error) {
                console.error('Failed to fetch Hacker News stories:', error);
                return [];
            }
        }

        static async fetchStory(id) {
            try {
                const response = await fetch(
                    `https://hacker-news.firebaseio.com/v0/item/${id}.json`
                );
                return await response.json();
            } catch (error) {
                console.error(`Failed to fetch story ${id}:`, error);
                return null;
            }
        }

        static formatTime(timestamp) {
            const now = Date.now();
            const storyTime = timestamp * 1000;
            const diffInHours = Math.floor(
                (now - storyTime) / (1000 * 60 * 60)
            );

            if (diffInHours < 1) {
                const diffInMinutes = Math.floor(
                    (now - storyTime) / (1000 * 60)
                );
                return `${diffInMinutes}m ago`;
            } else if (diffInHours < 24) {
                return `${diffInHours}h ago`;
            } else {
                const diffInDays = Math.floor(diffInHours / 24);
                return `${diffInDays}d ago`;
            }
        }

        static formatScore(score) {
            if (score >= 1000) {
                return `${(score / 1000).toFixed(1)}k`;
            }
            return score.toString();
        }
    };

    // Initialize
    registerServiceWorker();
</script>

<template id="clock-template">
    <style>
        .clock-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: calc(var(--space) * 0.5);
            margin-bottom: calc(var(--space) * 3);
        }

        .greeting {
            color: var(--color-text-subtle);
            font-size: 0.9rem;
            font-weight: var(--font-weight-normal);
            letter-spacing: var(--letter-spacing);
        }

        .time {
            color: var(--color-text);
            font-size: clamp(3.5rem, 10vw, 5rem);
            font-weight: var(--font-weight-bold);
            letter-spacing: -0.04em;
            line-height: 1;
            font-variant-numeric: tabular-nums;
        }

        .date {
            color: var(--color-text-subtle);
            font-size: 0.9rem;
            font-weight: var(--font-weight-normal);
            letter-spacing: var(--letter-spacing);
        }

        .keyboard-hint {
            color: var(--color-text-subtle);
            font-size: 0.8rem;
            margin-top: calc(var(--space) * 1.5);
            opacity: 0.6;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .keyboard-hint kbd {
            background: var(--color-focus);
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-family: inherit;
            font-size: 0.75rem;
        }
    </style>
    <div class="clock-container">
        <span class="greeting"></span>
        <time class="time"></time>
        <span class="date"></span>
        <span class="keyboard-hint">Press any key to search</span>
    </div>
</template>

<script type="module">
    class Clock extends HTMLElement {
        #greeting;
        #time;
        #date;
        #interval;

        constructor() {
            super();
            this.attachShadow({ mode: 'open' });
            this.#initializeTemplate();
            this.#updateClock();
            this.#interval = setInterval(() => this.#updateClock(), 1000);
        }

        disconnectedCallback() {
            if (this.#interval) clearInterval(this.#interval);
        }

        #initializeTemplate() {
            const template = document.getElementById('clock-template');
            const clone = template.content.cloneNode(true);
            this.#greeting = clone.querySelector('.greeting');
            this.#time = clone.querySelector('.time');
            this.#date = clone.querySelector('.date');
            this.shadowRoot.append(clone);
        }

        #updateClock() {
            const now = new Date();
            const hours = now.getHours();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            
            this.#time.textContent = `${hours}:${minutes}`;
            this.#greeting.textContent = this.#getGreeting(hours);
            this.#date.textContent = now.toLocaleDateString('en-US', {
                weekday: 'long',
                month: 'long',
                day: 'numeric'
            });
        }

        #getGreeting(hours) {
            if (hours >= 5 && hours < 12) return 'Good morning';
            if (hours >= 12 && hours < 17) return 'Good afternoon';
            if (hours >= 17 && hours < 21) return 'Good evening';
            return 'Good night';
        }
    }

    customElements.define('clock-component', Clock);
</script>

<template id="commands-template">
    <style>
        .commands {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2px;
            list-style: none;
            margin: 0 auto;
            max-width: 24rem;
            padding: 0;
            width: 100%;
            background: var(--color-focus);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        .command {
            display: flex;
            gap: calc(var(--space) * 0.75);
            outline: 0;
            padding: calc(var(--space) * 0.875) var(--space);
            position: relative;
            text-decoration: none;
            min-height: 44px;
            align-items: center;
            background: var(--color-background);
            transition: all var(--transition-speed) var(--transition-easing);
        }

        .command:hover {
            background: var(--color-focus);
        }

        .command:focus {
            outline: 2px solid var(--color-accent);
            outline-offset: -2px;
            z-index: 1;
        }

        .key {
            color: var(--color-accent);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 1.75rem;
            height: 1.75rem;
            font-weight: var(--font-weight-bold);
            font-size: 0.8rem;
            letter-spacing: 0;
            background: var(--color-accent-glow);
            border-radius: 0.375rem;
            flex-shrink: 0;
        }

        .name {
            color: var(--color-text-subtle);
            transition: color var(--transition-speed) var(--transition-easing);
            letter-spacing: var(--letter-spacing);
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .command:focus .name,
        .command:hover .name {
            color: var(--color-text);
        }

        @media (min-width: 600px) {
            .commands {
                grid-template-columns: repeat(3, 1fr);
                max-width: 36rem;
            }
        }

        @media (min-width: 900px) {
            .commands {
                grid-template-columns: repeat(4, 1fr);
                max-width: 48rem;
            }
        }
    </style>
    <nav>
        <menu class="commands"></menu>
    </nav>
</template>

<template id="command-template">
    <li>
        <a class="command" rel="noopener noreferrer">
            <span class="key"></span>
            <span class="name"></span>
        </a>
    </li>
</template>

<script type="module">
    class Commands extends HTMLElement {
        constructor() {
            super();
            this.attachShadow({ mode: 'open' });
            this.render();
        }

        render() {
            const template = document.getElementById('commands-template');
            const clone = template.content.cloneNode(true);
            const commandsContainer = clone.querySelector('.commands');
            const commandTemplate = document.getElementById('command-template');

            const fragment = this.createCommandsFragment(commandTemplate);
            commandsContainer.appendChild(fragment);

            this.shadowRoot.append(clone);
        }

        createCommandsFragment(commandTemplate) {
            const fragment = document.createDocumentFragment();
            for (const [key, { name, url }] of COMMANDS.entries()) {
                if (!name || !url) continue;
                const commandClone = this.createCommandElement(
                    commandTemplate,
                    key,
                    name,
                    url
                );
                fragment.appendChild(commandClone);
            }
            return fragment;
        }

        createCommandElement(template, key, name, url) {
            const clone = template.content.cloneNode(true);
            const command = clone.querySelector('.command');
            command.href = url;
            if (CONFIG.openLinksInNewTab) command.target = '_blank';
            clone.querySelector('.key').innerText = key;
            clone.querySelector('.name').innerText = name;
            return clone;
        }
    }

    customElements.define('commands-component', Commands);
</script>

<template id="search-template">
    <style>
        input,
        button {
            appearance: none;
            background: transparent;
            border: 0;
            display: block;
            outline: 0;
        }

        .dialog {
            align-items: center;
            background: var(--color-background);
            border: none;
            display: none;
            flex-direction: column;
            height: 100%;
            justify-content: center;
            left: 0;
            padding: 0;
            top: 0;
            width: 100%;
        }

        .dialog[open] {
            display: flex;
        }

        .form {
            width: 100%;
        }

        .input {
            color: var(--color-text);
            font-size: clamp(2rem, 6vw, 3rem);
            font-weight: var(--font-weight-bold);
            padding: 0;
            text-align: center;
            width: 100%;
            letter-spacing: -0.02em;
        }

        .input::placeholder {
            color: var(--color-text-subtle);
            opacity: 0.5;
        }

        .suggestions {
            align-items: center;
            display: flex;
            flex-direction: column;
            flex-wrap: wrap;
            justify-content: center;
            list-style: none;
            margin: var(--space) 0 0;
            overflow: hidden;
            padding: 0;
        }

        .suggestion {
            color: var(--color-text);
            cursor: pointer;
            font-size: 0.9rem;
            padding: calc(var(--space) * 0.75) var(--space);
            position: relative;
            transition: all var(--transition-speed) var(--transition-easing);
            white-space: nowrap;
            z-index: 1;
            border-radius: 0.5rem;
            outline: 0;
            background: var(--color-focus);
        }

        .suggestion:focus,
        .suggestion:hover {
            color: var(--color-background);
            background: var(--color-text);
        }

        .suggestion:focus {
            outline: 2px solid var(--color-accent);
            outline-offset: 2px;
        }

        .match {
            color: var(--color-accent);
            transition: color var(--transition-speed) var(--transition-easing);
            font-weight: var(--font-weight-bold);
        }

        .suggestion:focus .match,
        .suggestion:hover .match {
            color: var(--color-background);
        }

        @media (min-width: 700px) {
            .suggestions {
                flex-direction: row;
            }
        }
    </style>
    <dialog class="dialog">
        <form
            autocomplete="off"
            class="form"
            method="dialog"
            spellcheck="false"
        >
            <input
                class="input"
                title="search"
                type="text"
                placeholder="Type to search..."
            />
            <menu class="suggestions"></menu>
        </form>
    </dialog>
</template>

<template id="suggestion-template">
    <li>
        <button class="suggestion" type="button"></button>
    </li>
</template>

<template id="match-template">
    <span class="match"></span>
</template>

<script type="module">
    class Search extends HTMLElement {
        #dialog;
        #form;
        #input;
        #suggestions;

        constructor() {
            super();
            this.attachShadow({ mode: 'open' });
            this.#initializeTemplate();
            this.#initializeEventListeners();
        }

        #initializeTemplate() {
            const template = document.getElementById('search-template');
            const clone = template.content.cloneNode(true);
            this.#dialog = clone.querySelector('.dialog');
            this.#form = clone.querySelector('.form');
            this.#input = clone.querySelector('.input');
            this.#suggestions = clone.querySelector('.suggestions');
            this.shadowRoot.append(clone);
        }

        #initializeEventListeners() {
            this.#form.addEventListener(
                'submit',
                this.#onSubmit.bind(this),
                false
            );
            this.#input.addEventListener('input', this.#onInput.bind(this));
            this.#suggestions.addEventListener(
                'click',
                this.#onSuggestionClick.bind(this)
            );
            document.addEventListener('keydown', this.#onKeydown.bind(this));
        }

        static #escapeRegexCharacters(s) {
            return s.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&');
        }

        static #fetchDuckDuckGoSuggestions(search) {
            return new Promise((resolve) => {
                window.autocompleteCallback = (res) => {
                    const suggestions = res
                        .filter((item) => item.phrase !== search.toLowerCase())
                        .map((item) => item.phrase);
                    resolve(suggestions);
                };

                const script = document.createElement('script');
                document.querySelector('head').appendChild(script);
                script.src = `https://duckduckgo.com/ac/?callback=autocompleteCallback&q=${search}`;
                script.onload = () => script.remove();
            });
        }

        static #formatSearchUrl(template, search) {
            return template.replace(/{}/g, encodeURIComponent(search));
        }

        static #hasProtocol(s) {
            return /^[a-zA-Z]+:\/\//i.test(s);
        }

        static #isUrl(s) {
            return /^((https?:\/\/)?[\w-]+(\.[\w-]+)+\.?(:\d+)?(\/\S*)?)$/i.test(
                s
            );
        }

        static #compareKey(key) {
            return CONFIG.commandCaseSensitive ? key : key.toLowerCase();
        }

        static #getCommand(key) {
            if (CONFIG.commandCaseSensitive) {
                return COMMANDS.get(key);
            } else {
                const lowerKey = key.toLowerCase();
                for (const [cmdKey, value] of COMMANDS) {
                    if (cmdKey.toLowerCase() === lowerKey) {
                        return value;
                    }
                }
                return undefined;
            }
        }

        static #parseQuery(raw) {
            const query = raw.trim();
            const compareQuery = this.#compareKey(query);

            if (this.#isUrl(query)) {
                const url = this.#hasProtocol(query)
                    ? query
                    : `https://${query}`;
                return { query, url };
            }

            const command = this.#getCommand(query);
            if (command) {
                return { key: query, query, url: command.url };
            }

            const [commandPart, searchPart] = query.split(
                new RegExp(`${CONFIG.commandSearchDelimiter}(.*)`)
            );
            const commandPartCommand = this.#getCommand(commandPart);
            if (commandPartCommand) {
                const search = searchPart ? searchPart.trim() : '';
                const template = new URL(
                    commandPartCommand.searchTemplate ?? '',
                    commandPartCommand.url
                );
                const url = this.#formatSearchUrl(
                    decodeURI(template.href),
                    search
                );
                return { key: commandPart, query, search, url };
            }

            const [pathKey, path] = query.split(
                new RegExp(`${CONFIG.commandPathDelimiter}(.*)`)
            );
            const pathKeyCommand = this.#getCommand(pathKey);
            if (pathKeyCommand) {
                const url = `${new URL(pathKeyCommand.url).origin}/${path || ''}`;
                return { key: pathKey, path, query, url };
            }

            const url = this.#formatSearchUrl(
                CONFIG.defaultSearchTemplate,
                query
            );
            return { query, search: query, url };
        }

        #close() {
            this.#input.value = '';
            this.#input.blur();
            this.#dialog.close();
            this.#suggestions.innerHTML = '';
        }

        #execute(query) {
            const target = CONFIG.openLinksInNewTab ? '_blank' : '_self';
            window.open(
                Search.#parseQuery(query).url,
                target,
                'noopener noreferrer'
            );
            this.#close();
        }

        #focusNextSuggestion(previous = false) {
            const active = this.shadowRoot.activeElement;
            let nextIndex;

            if (active.dataset.index) {
                const activeIndex = Number(active.dataset.index);
                nextIndex = previous ? activeIndex - 1 : activeIndex + 1;
            } else {
                nextIndex = previous
                    ? this.#suggestions.childElementCount - 1
                    : 0;
            }

            const next = this.#suggestions.children[nextIndex];
            if (next) next.querySelector('.suggestion').focus();
            else this.#input.focus();
        }

        async #onInput() {
            const parsedQuery = Search.#parseQuery(this.#input.value);

            if (!parsedQuery.query) {
                this.#close();
                return;
            }

            const command = Search.#getCommand(
                parsedQuery.key || parsedQuery.query
            );
            let suggestions = command?.suggestions ?? [];

            if (
                parsedQuery.search &&
                suggestions.length < CONFIG.suggestionLimit
            ) {
                const ddgSuggestions = await Search.#fetchDuckDuckGoSuggestions(
                    parsedQuery.search
                );
                suggestions = suggestions.concat(
                    parsedQuery.key
                        ? ddgSuggestions.map(
                              (s) =>
                                  `${parsedQuery.key}${CONFIG.commandSearchDelimiter}${s}`
                          )
                        : ddgSuggestions
                );
            }

            const newParsedQuery = Search.#parseQuery(this.#input.value);
            if (
                Search.#compareKey(newParsedQuery.query) !==
                Search.#compareKey(parsedQuery.query)
            )
                return;

            const filteredSuggestions = CONFIG.commandCaseSensitive
                ? suggestions
                : suggestions.filter((s) =>
                      Search.#compareKey(s).startsWith(
                          Search.#compareKey(parsedQuery.query)
                      )
                  );

            this.#renderSuggestions(filteredSuggestions, parsedQuery.query);
        }

        #onKeydown(e) {
            if (!this.#dialog.open) {
                this.#dialog.show();
                this.#input.focus();

                requestAnimationFrame(() => {
                    if (!this.#input.value) this.#close();
                });

                return;
            }

            if (e.key === 'Escape') {
                this.#close();
                return;
            }

            const modifierPrefixedKey = this.#getModifierPrefixedKey(e);

            if (/^(ArrowDown|Tab|ctrl-n)$/.test(modifierPrefixedKey)) {
                e.preventDefault();
                this.#focusNextSuggestion();
                return;
            }

            if (/^(ArrowUp|ctrl-p|shift-Tab)$/.test(modifierPrefixedKey)) {
                e.preventDefault();
                this.#focusNextSuggestion(true);
            }
        }

        #getModifierPrefixedKey(e) {
            const alt = e.altKey ? 'alt-' : '';
            const ctrl = e.ctrlKey ? 'ctrl-' : '';
            const meta = e.metaKey ? 'meta-' : '';
            const shift = e.shiftKey ? 'shift-' : '';
            return `${alt}${ctrl}${meta}${shift}${e.key}`;
        }

        #onSubmit() {
            this.#execute(this.#input.value);
        }

        #onSuggestionClick(e) {
            const ref = e.target.closest('.suggestion');
            if (!ref) return;
            this.#execute(ref.dataset.suggestion);
        }

        #renderSuggestions(suggestions, query) {
            this.#suggestions.innerHTML = '';
            const template = document.getElementById('suggestion-template');
            const matchTemplate = document.getElementById('match-template');

            const fragment = document.createDocumentFragment();
            suggestions
                .slice(0, CONFIG.suggestionLimit)
                .forEach((suggestion, index) => {
                    const clone = template.content.cloneNode(true);
                    const ref = clone.querySelector('.suggestion');
                    ref.dataset.index = index;
                    ref.dataset.suggestion = suggestion;

                    const compareQuery = Search.#compareKey(query);
                    const compareSuggestion = Search.#compareKey(suggestion);
                    const matchIndex = compareSuggestion.indexOf(compareQuery);

                    if (matchIndex !== -1) {
                        const pre = suggestion.slice(0, matchIndex);
                        const match = suggestion.slice(
                            matchIndex,
                            matchIndex + query.length
                        );
                        const post = suggestion.slice(
                            matchIndex + query.length
                        );

                        const matchClone =
                            matchTemplate.content.cloneNode(true);
                        const matchRef = matchClone.querySelector('.match');
                        matchRef.textContent = match;

                        ref.append(
                            document.createTextNode(pre),
                            matchClone,
                            document.createTextNode(post)
                        );
                    } else {
                        ref.textContent = suggestion;
                    }

                    fragment.appendChild(clone);
                });

            this.#suggestions.appendChild(fragment);
        }
    }

    customElements.define('search-component', Search);
</script>

<template id="news-template">
    <style>
        .news-container {
            margin-top: 0;
            max-width: 48rem;
            width: 100%;
        }

        .news-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: calc(var(--space) * 0.75);
            padding: 0 calc(var(--space) * 0.5);
        }

        .news-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--color-text-subtle);
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: var(--font-weight-bold);
            letter-spacing: 0.08em;
            text-transform: uppercase;
            transition: color var(--transition-speed) var(--transition-easing);
        }

        .news-title:hover {
            color: var(--color-text);
        }

        .news-title svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
            opacity: 0.7;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cache-time {
            color: var(--color-text-subtle);
            font-size: 0.7rem;
            opacity: 0.6;
        }

        .refresh-btn {
            background: transparent;
            border: none;
            color: var(--color-text-subtle);
            padding: 0.375rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all var(--transition-speed) var(--transition-easing);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .refresh-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
            transition: transform 0.5s var(--transition-easing);
        }

        .refresh-btn:hover {
            background: var(--color-focus);
            color: var(--color-text);
        }

        .refresh-btn:hover svg {
            transform: rotate(180deg);
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .refresh-btn:disabled svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .news-list {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 1px;
            background: var(--color-focus);
            border-radius: calc(var(--border-radius) * 0.75);
            overflow: hidden;
        }

        .news-item {
            display: grid;
            grid-template-columns: 3rem 1fr auto;
            align-items: center;
            gap: calc(var(--space) * 0.75);
            padding: calc(var(--space) * 0.75) var(--space);
            background: var(--color-background);
            transition: all var(--transition-speed) var(--transition-easing);
            text-decoration: none;
            color: inherit;
            outline: 0;
        }

        .news-item:hover {
            background: var(--color-focus);
        }

        .news-item:focus {
            outline: 2px solid var(--color-accent);
            outline-offset: -2px;
            z-index: 1;
        }

        .news-item-rank {
            color: var(--color-text-subtle);
            font-size: 0.8rem;
            font-weight: var(--font-weight-bold);
            font-variant-numeric: tabular-nums;
            text-align: center;
            opacity: 0.5;
        }

        .news-item-content {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            min-width: 0;
        }

        .news-item-title {
            color: var(--color-text);
            font-size: 0.9rem;
            font-weight: var(--font-weight-normal);
            line-height: 1.35;
            margin: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .news-item-meta {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--color-text-subtle);
            font-size: 0.7rem;
        }

        .news-item-domain {
            opacity: 0.7;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .meta-separator {
            opacity: 0.3;
        }

        .news-item-stats {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.125rem;
            flex-shrink: 0;
        }

        .score-badge {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--color-accent);
            font-size: 0.75rem;
            font-weight: var(--font-weight-bold);
            font-variant-numeric: tabular-nums;
        }

        .score-badge svg {
            width: 10px;
            height: 10px;
            fill: currentColor;
        }

        .time-badge {
            color: var(--color-text-subtle);
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .comments-link {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--color-text-subtle);
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .comments-link svg {
            width: 10px;
            height: 10px;
            fill: currentColor;
        }

        .loading {
            text-align: center;
            color: var(--color-text-subtle);
            padding: calc(var(--space) * 2);
            font-size: 0.85rem;
            background: var(--color-background);
            border-radius: calc(var(--border-radius) * 0.75);
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-focus);
            border-top-color: var(--color-accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 0.5rem;
            vertical-align: middle;
        }

        .error {
            text-align: center;
            color: var(--color-text-subtle);
            padding: var(--space);
            font-size: 0.85rem;
            opacity: 0.7;
        }

        @media (min-width: 700px) {
            .news-item {
                grid-template-columns: 2.5rem 1fr auto;
                padding: calc(var(--space) * 0.875) calc(var(--space) * 1.25);
            }

            .news-item-title {
                font-size: 0.925rem;
                -webkit-line-clamp: 1;
            }

            .news-item-stats {
                flex-direction: row;
                gap: var(--space);
            }
        }
    </style>
    <div class="news-container">
        <div class="news-header">
            <a
                href="https://news.ycombinator.com"
                target="_blank"
                rel="noopener noreferrer"
                class="news-title"
            >
                <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                    <path d="M0 0v16h16V0H0zm8.8 9.6V14H7.2V9.6L3.6 2h1.8l3.6 6 3.6-6h1.8L8.8 9.6z"/>
                </svg>
                Hacker News
            </a>
            <div class="header-actions">
                <span class="cache-time"></span>
                <button class="refresh-btn" type="button" title="Refresh stories">
                    <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                        <path d="M13.65 2.35A8 8 0 1 0 16 8h-2a6 6 0 1 1-1.76-4.24L10 6h6V0l-2.35 2.35z"/>
                    </svg>
                </button>
            </div>
        </div>
        <ul class="news-list"></ul>
        <div class="loading"><span class="loading-spinner"></span>Loading stories...</div>
    </div>
</template>

<template id="news-item-template">
    <li>
        <a class="news-item" target="_blank" rel="noopener noreferrer">
            <span class="news-item-rank"></span>
            <div class="news-item-content">
                <h3 class="news-item-title"></h3>
                <div class="news-item-meta">
                    <span class="news-item-domain"></span>
                    <span class="meta-separator">Â·</span>
                    <span class="comments-link">
                        <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                            <path d="M14 1H2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h3l3 3 3-3h3a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2z"/>
                        </svg>
                        <span class="comments-count"></span>
                    </span>
                </div>
            </div>
            <div class="news-item-stats">
                <div class="score-badge">
                    <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                        <path d="M8 0l2.5 5 5.5.8-4 3.9.9 5.5L8 12.5l-4.9 2.7.9-5.5-4-3.9L5.5 5z"/>
                    </svg>
                    <span class="score"></span>
                </div>
                <span class="time-badge"></span>
            </div>
        </a>
    </li>
</template>

<script type="module">
    class NewsFeed extends HTMLElement {
        #container;
        #newsList;
        #loading;
        #refreshBtn;
        #cacheTime;
        #stories = [];
        #CACHE_KEY = 'hacker-news-stories';
        #CACHE_DURATION = 30 * 60 * 1000; // 30 minutes

        constructor() {
            super();
            this.attachShadow({ mode: 'open' });
            this.#initializeTemplate();
            this.#initializeEventListeners();
            this.#loadStories();
        }

        #initializeTemplate() {
            const template = document.getElementById('news-template');
            const clone = template.content.cloneNode(true);
            this.#container = clone.querySelector('.news-container');
            this.#newsList = clone.querySelector('.news-list');
            this.#loading = clone.querySelector('.loading');
            this.#refreshBtn = clone.querySelector('.refresh-btn');
            this.#cacheTime = clone.querySelector('.cache-time');
            this.shadowRoot.append(clone);
        }

        #initializeEventListeners() {
            this.#refreshBtn.addEventListener('click', () => {
                this.#loadStories(true);
            });
        }

        #isCacheValid() {
            try {
                const cached = localStorage.getItem(this.#CACHE_KEY);
                if (!cached) return false;

                const { timestamp } = JSON.parse(cached);
                return Date.now() - timestamp < this.#CACHE_DURATION;
            } catch {
                return false;
            }
        }

        #getCachedStories() {
            try {
                const cached = localStorage.getItem(this.#CACHE_KEY);
                return JSON.parse(cached);
            } catch {
                return null;
            }
        }

        #updateCacheTimeDisplay() {
            try {
                const cached = localStorage.getItem(this.#CACHE_KEY);
                if (cached) {
                    const { timestamp } = JSON.parse(cached);
                    const minutes = Math.floor((Date.now() - timestamp) / 60000);
                    if (minutes < 1) {
                        this.#cacheTime.textContent = 'just now';
                    } else if (minutes === 1) {
                        this.#cacheTime.textContent = '1m ago';
                    } else {
                        this.#cacheTime.textContent = `${minutes}m ago`;
                    }
                }
            } catch {
                this.#cacheTime.textContent = '';
            }
        }

        #setCachedStories(stories) {
            try {
                const cacheData = {
                    stories,
                    timestamp: Date.now(),
                };
                localStorage.setItem(
                    this.#CACHE_KEY,
                    JSON.stringify(cacheData)
                );
            } catch (error) {
                console.warn('Failed to cache stories:', error);
            }
        }

        async #loadStories(forceRefresh = false) {
            this.#refreshBtn.disabled = true;
            this.#loading.style.display = 'block';
            this.#newsList.style.display = 'none';

            try {
                // Check if we have valid cached stories
                if (!forceRefresh && this.#isCacheValid()) {
                    const cached = this.#getCachedStories();
                    if (cached && cached.stories && cached.stories.length > 0) {
                        this.#stories = cached.stories;
                        this.#renderStories();
                        this.#updateCacheTimeDisplay();
                        this.#loading.style.display = 'none';
                        this.#newsList.style.display = 'flex';
                        this.#refreshBtn.disabled = false;
                        return;
                    }
                }

                // Fetch fresh stories
                this.#stories = await HackerNewsAPI.fetchTopStories(10);
                this.#setCachedStories(this.#stories);
                this.#renderStories();
                this.#updateCacheTimeDisplay();
                this.#loading.style.display = 'none';
                this.#newsList.style.display = 'flex';
            } catch (error) {
                console.error('Failed to load stories:', error);

                // Try to show cached stories even if expired
                const cached = this.#getCachedStories();
                if (cached && cached.stories && cached.stories.length > 0) {
                    this.#stories = cached.stories;
                    this.#renderStories();
                    this.#loading.textContent =
                        'Showing cached stories (offline)';
                    this.#loading.className = 'error';
                } else {
                    this.#loading.textContent = 'Failed to load stories';
                    this.#loading.className = 'error';
                }
            } finally {
                this.#refreshBtn.disabled = false;
            }
        }

        #renderStories() {
            const template = document.getElementById('news-item-template');
            const fragment = document.createDocumentFragment();

            this.#stories.forEach((story, index) => {
                const clone = template.content.cloneNode(true);
                const newsItem = clone.querySelector('.news-item');
                const rank = clone.querySelector('.news-item-rank');
                const title = clone.querySelector('.news-item-title');
                const domain = clone.querySelector('.news-item-domain');
                const score = clone.querySelector('.score');
                const time = clone.querySelector('.time-badge');
                const commentsCount = clone.querySelector('.comments-count');

                newsItem.href =
                    story.url ||
                    `https://news.ycombinator.com/item?id=${story.id}`;
                rank.textContent = `${index + 1}`;
                title.textContent = story.title;

                if (story.url) {
                    try {
                        const url = new URL(story.url);
                        domain.textContent = url.hostname.replace(/^www\./, '');
                    } catch {
                        domain.textContent = '';
                    }
                } else {
                    domain.textContent = 'news.ycombinator.com';
                }

                score.textContent = HackerNewsAPI.formatScore(story.score || 0);
                time.textContent = HackerNewsAPI.formatTime(story.time || 0);
                commentsCount.textContent = story.descendants || 0;

                fragment.appendChild(clone);
            });

            this.#newsList.innerHTML = '';
            this.#newsList.appendChild(fragment);
        }
    }

    customElements.define('news-feed-component', NewsFeed);
</script>

<style>
    /* Global Styles */
    html {
        background-color: var(--color-background);
        font-family: var(--font-family);
        font-size: var(--font-size);
        line-height: 1.4;
        letter-spacing: var(--letter-spacing);
        overflow-x: hidden;
        scrollbar-width: none; /* Firefox */
    }

    html::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Edge */
    }

    body {
        margin: 0;
        overflow-x: hidden;
        scrollbar-width: none; /* Firefox */
    }

    body::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Edge */
    }

    /* Main Container Styles */
    main {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        box-sizing: border-box;
        min-height: 100dvh;
        width: 100vw;
        padding: calc(var(--space) * 6) var(--space) calc(var(--space) * 4);
        overflow: hidden;
        position: relative;
        opacity: 0;
        animation: fadeIn 0.5s var(--transition-easing) forwards;
        scrollbar-width: none; /* Firefox */
    }

    main::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Edge */
    }

    .main-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        flex: 1;
        width: 100%;
        max-width: 48rem;
    }

    /* News Section Styles */
    .news-section {
        display: flex;
        justify-content: center;
        width: 100%;
        padding: 0 var(--space);
        margin-top: calc(var(--space) * 4);
    }

    @keyframes fadeIn {
        to {
            opacity: 1;
        }
    }
</style>

<main>
    <div class="main-content">
        <clock-component></clock-component>
        <commands-component></commands-component>
        <search-component></search-component>
    </div>
</main>

<section class="news-section">
    <news-feed-component></news-feed-component>
</section>
