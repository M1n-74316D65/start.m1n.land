<!doctype html>
<meta charset="utf-8" />
<meta name="color-scheme" content="dark light" />
<meta name="robots" content="noindex" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta
  name="theme-color"
  content="#0a0a0a"
  media="(prefers-color-scheme: dark)"
/>
<meta
  name="theme-color"
  content="#fafafa"
  media="(prefers-color-scheme: light)"
/>
<meta name="mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="M1n Startpage" />
<meta name="application-name" content="M1n Startpage" />
<link rel="manifest" href="/manifest.json" />
<link rel="apple-touch-icon" href="/images/favicon-8.png" />
<link rel="icon" type="image/x-icon" href="/favicon.ico" />
<title>M1n Startpage</title>

<style>
  :root {
    --border-radius: 0.25rem;
    --color-background: #0c0d0d;
    --color-text-subtle: #8b8f8f;
    --color-text: #e6e8e6;
    --color-focus: #1a1d1d;
    --color-accent: #6aa84f;
    --color-accent-glow: rgba(106, 168, 79, 0.08);
    --color-scanline: rgba(255, 255, 255, 0.03);
    --font-family: 'IBM Plex Mono', 'SFMono-Regular', Menlo, Monaco, Consolas,
      'Liberation Mono', monospace;
    --font-size: clamp(14px, 1.2vw, 16px);
    --font-weight-bold: 500;
    --font-weight-normal: 400;
    --letter-spacing: 0.01em;
    --space: 0.875rem;
    --transition-speed: 180ms;
    --transition-easing: cubic-bezier(0.4, 0, 0.2, 1);
    --transition-speed-fast: 100ms;
  
    --grid-border: 1px solid var(--color-focus);
  }

  @media (prefers-color-scheme: light) {
    :root {
      --color-background: #f3f4f4;
      --color-text-subtle: #606565;
      --color-text: #1c1d1d;
      --color-focus: #e0e3e3;
      --color-accent: #5b8f3b;
      --color-accent-glow: rgba(91, 143, 59, 0.06);
      --color-scanline: rgba(0, 0, 0, 0.03);
    }
  }
</style>

<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet" />

<script>
  // Service Worker Registration
  function registerServiceWorker() {
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').then(
          (registration) => {
            console.log('ServiceWorker registration successful with scope:', registration.scope);
          },
          (error) => {
            console.log('ServiceWorker registration failed:', error);
          }
        );
      });

      // Listen for cache update notifications from service worker
      navigator.serviceWorker.addEventListener('message', (event) => {
        if (event.data && event.data.type === 'CACHE_UPDATED') {
          console.log('PWA cache updated successfully');
        }
      });
    }
  }

  // PWA Cache Update Function
  function updatePWACache() {
    if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
      navigator.serviceWorker.controller.postMessage({
        type: 'UPDATE_CACHE',
      });
      console.log('PWA cache update requested');
    }
  }

  // Global keyboard event listener for Force Refresh
  document.addEventListener('keydown', (event) => {
    // Check for Ctrl+Shift+R (Windows/Linux) or Cmd+Shift+R (macOS)
    if ((event.ctrlKey || event.metaKey) && event.shiftKey && event.key === 'r') {
      event.preventDefault();
      updatePWACache();
    }

    // Tab switching with Alt/Option + number keys (Windows/Linux) or Command + number keys (macOS)
    if ((event.altKey || event.metaKey) && /^[1-9]$/.test(event.key)) {
      event.preventDefault();
      const tabIndex = parseInt(event.key) - 1;
      if (tabIndex < workspaceManager.workspaces.length) {
        const workspaceId = workspaceManager.workspaces[tabIndex].id;
        workspaceManager.switchTo(workspaceId);
      }
    }
  });

  // Configuration
  const CONFIG = {
    commandPathDelimiter: '/',
    commandSearchDelimiter: ' ',
    commandCaseSensitive: false,
    defaultSearchTemplate: 'https://www.google.com/search?q={}',
    openLinksInNewTab: false,
    suggestionLimit: 4,
    defaultWorkspace: 'personal',
    workspaceStorageKey: 'm1n-active-workspace',
  };

  // Commands
  const COMMANDS = new Map([
    // Personal (alphabetical by key)
    ['1', { name: 'M1n', url: 'https://m1n.land/', workspace: 'personal' }],
    ['A', { name: 'Mastodon', url: 'https://social.lol', workspace: 'personal' }],
    ['B', { name: 'Pastebin', url: 'https://paste.m1n.land/', workspace: 'personal' }],
    ['C', { name: 'Kimi', url: 'https://www.kimi.com/bot', workspace: 'personal' }],
    ['G', { name: 'Proton Mail', url: 'https://mail.proton.me', workspace: 'personal' }],
    ['M', { name: 'Mymemo', url: 'https://app.mymemo.ai/home', workspace: 'personal' }],
    ['R', { name: 'RSS feed', url: 'https://owl.report/', workspace: 'personal' }],
    ['T', { name: 'Twitch', url: 'https://www.twitch.tv', workspace: 'personal' }],
    ['W', { name: 'Weather', url: 'https://merrysky.net/', workspace: 'personal' }],
    ['Y', { name: 'YouTube', url: 'https://youtube.com', searchTemplate: '/results?search_query={}', workspace: 'personal' }],
    // Dev (alphabetical by key)
    ['E', { name: 'TRAE', url: 'https://www.trae.ai/account-setting#usage', workspace: 'dev' }],
    ['F', { name: 'Cloudflare', url: 'https://dash.cloudflare.com', workspace: 'dev' }],
    ['H', { name: 'GitHub', url: 'https://github.com/', workspace: 'dev' }],
    ['I', { name: 'Pico', url: 'https://pico.sh', workspace: 'dev' }],
    ['N', { name: 'Neon', url: 'https://neon.tech', workspace: 'dev' }],
    ['S', { name: 'Server', url: 'http://192.168.1.139', workspace: 'dev' }],
    ['U', { name: 'Sourcehut', url: 'https://sr.ht', workspace: 'dev' }],
    ['V', { name: 'Vercel', url: 'https://vercel.com/dashboard', workspace: 'dev' }],
    // Work (alphabetical by key)
    ['J', { name: 'Mymemo', url: 'https://app.mymemo.ai/home', workspace: 'work' }],
    ['O', { name: 'Outlook', url: 'https://outlook.office.com', workspace: 'work' }],
  ]);

  // Workspace Manager
  class WorkspaceManager {
    static #instance;
    #activeWorkspaceId;
    #workspaces;

    constructor() {
      if (WorkspaceManager.#instance) {
        return WorkspaceManager.#instance;
      }
      WorkspaceManager.#instance = this;
      this.#workspaces = this.#generateWorkspaces();
      this.#loadActiveWorkspace();
    }

    static get instance() {
      if (!WorkspaceManager.#instance) {
        WorkspaceManager.#instance = new WorkspaceManager();
      }
      return WorkspaceManager.#instance;
    }

    get workspaces() {
      return this.#workspaces;
    }

    get activeWorkspaceId() {
      return this.#activeWorkspaceId;
    }

    get activeWorkspace() {
      return this.#workspaces.find((w) => w.id === this.#activeWorkspaceId);
    }

    #generateWorkspaces() {
      const workspaceMap = new Map();
      for (const [key, command] of COMMANDS.entries()) {
        const workspaceId = command.workspace || 'default';
        if (!workspaceMap.has(workspaceId)) {
          workspaceMap.set(workspaceId, {
            id: workspaceId,
            name: workspaceId.charAt(0).toUpperCase() + workspaceId.slice(1),
            commands: [],
          });
        }
        workspaceMap.get(workspaceId).commands.push(key);
      }
      const orderedWorkspaces = Array.from(workspaceMap.values());
      const order = ['personal', 'dev', 'work'];
      orderedWorkspaces.sort((a, b) => {
        const indexA = order.indexOf(a.id);
        const indexB = order.indexOf(b.id);
        if (indexA !== -1 && indexB !== -1) return indexA - indexB;
        if (indexA !== -1) return -1;
        if (indexB !== -1) return 1;
        return a.id.localeCompare(b.id);
      });
      return orderedWorkspaces;
    }

    #loadActiveWorkspace() {
      try {
        const stored = localStorage.getItem(CONFIG.workspaceStorageKey);
        // Verify if stored workspace still exists
        const exists = this.#workspaces.some(w => w.id === stored);
        this.#activeWorkspaceId = exists ? stored : CONFIG.defaultWorkspace;
      } catch {
        this.#activeWorkspaceId = CONFIG.defaultWorkspace;
      }
    }

    switchTo(workspaceId) {
      if (this.#activeWorkspaceId === workspaceId) return;
      
      const exists = this.#workspaces.some(w => w.id === workspaceId);
      if (!exists) return;

      this.#activeWorkspaceId = workspaceId;
      try {
        localStorage.setItem(CONFIG.workspaceStorageKey, workspaceId);
      } catch (error) {
        console.warn('Failed to save workspace:', error);
      }

      // Add subtle fade transition for workspace change
      document.body.style.transition = 'opacity 0.15s ease';
      document.body.style.opacity = '0.9';
      
      setTimeout(() => {
        window.dispatchEvent(
          new CustomEvent('workspacechange', {
            detail: { 
              workspace: this.activeWorkspace, 
              workspaceId: this.#activeWorkspaceId 
            },
            bubbles: true,
          })
        );
        
        setTimeout(() => {
          document.body.style.opacity = '1';
          setTimeout(() => {
            document.body.style.transition = '';
          }, 150);
        }, 50);
      }, 50);
    }

    getCommandsForWorkspace(workspaceId) {
      const workspace = this.#workspaces.find(w => w.id === workspaceId);
      if (!workspace || !workspace.commands) return new Map();

      const workspaceCommands = new Map();
      workspace.commands.forEach((key) => {
        const command = COMMANDS.get(key);
        if (command) {
          workspaceCommands.set(key, command);
        }
      });
      return workspaceCommands;
    }
  }

  // Initialize WorkspaceManager
  const workspaceManager = new WorkspaceManager();

  // Usage Tracker for sorting commands by frequency
  class UsageTracker {
    static #STORAGE_KEY = 'm1n-command-usage';
    static #usageData = null;

    static #loadUsageData() {
      if (this.#usageData !== null) return this.#usageData;
      try {
        const stored = localStorage.getItem(this.#STORAGE_KEY);
        this.#usageData = stored ? JSON.parse(stored) : {};
      } catch {
        this.#usageData = {};
      }
      return this.#usageData;
    }

    static #saveUsageData() {
      try {
        localStorage.setItem(this.#STORAGE_KEY, JSON.stringify(this.#usageData));
      } catch {
        // Silently fail if storage is unavailable
      }
    }

    static recordUsage(commandKey) {
      this.#loadUsageData();
      this.#usageData[commandKey] = (this.#usageData[commandKey] || 0) + 1;
      this.#saveUsageData();
    }

    static getUsageCount(commandKey) {
      this.#loadUsageData();
      return this.#usageData[commandKey] || 0;
    }

    static resetUsage(commandKey = null) {
      this.#loadUsageData();
      if (commandKey) {
        delete this.#usageData[commandKey];
      } else {
        this.#usageData = {};
      }
      this.#saveUsageData();
    }
  }

  // Hacker News API functionality
  window.HackerNewsAPI = class HackerNewsAPI {
    static async fetchTopStories(limit = 10) {
      try {
        const response = await fetch(
          'https://hacker-news.firebaseio.com/v0/topstories.json'
        );
        const storyIds = await response.json();
        const topStoryIds = storyIds.slice(0, limit);

        const storyPromises = topStoryIds.map((id) => this.fetchStory(id));
        const stories = await Promise.all(storyPromises);

        return stories.filter((story) => story !== null);
      } catch (error) {
        console.error('Failed to fetch Hacker News stories:', error);
        return [];
      }
    }

    static async fetchStory(id) {
      try {
        const response = await fetch(
          `https://hacker-news.firebaseio.com/v0/item/${id}.json`
        );
        return await response.json();
      } catch (error) {
        console.error(`Failed to fetch story ${id}:`, error);
        return null;
      }
    }

    static formatTime(timestamp) {
      const diffMs = Date.now() - timestamp * 1000;
      const diffMins = Math.floor(diffMs / 60000);
      
      if (diffMins < 60) return `${diffMins}m ago`;
      const diffHours = Math.floor(diffMins / 60);
      if (diffHours < 24) return `${diffHours}h ago`;
      return `${Math.floor(diffHours / 24)}d ago`;
    }

    static formatScore(score) {
      if (score >= 1000) {
        return `${(score / 1000).toFixed(1)}k`;
      }
      return score.toString();
    }
  };

  // Dynamic theme color updater
  function updateThemeColor() {
    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const color = isDark ? '#0c0d0d' : '#f3f4f4';
    document.querySelector('meta[name="theme-color"]')?.setAttribute('content', color);
  }

  // Listen for color scheme changes
  window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateThemeColor);
  updateThemeColor();

  // PWA Install detection
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    console.log('PWA install available');
  });

  window.addEventListener('appinstalled', () => {
    deferredPrompt = null;
    console.log('PWA installed');
  });

  // Initialize
  registerServiceWorker();
</script>

<template id="clock-template">
  <style>
    .clock-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: calc(var(--space) * 0.35);
      margin-bottom: calc(var(--space) * 2.5);
    }

    .greeting {
      color: var(--color-text-subtle);
      font-size: 0.75rem;
      font-weight: var(--font-weight-normal);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .time {
      color: var(--color-text);
      font-size: clamp(2.5rem, 7vw, 4rem);
      font-weight: 600;
      letter-spacing: 0.02em;
      line-height: 1;
      font-variant-numeric: tabular-nums;
      transition: opacity var(--transition-speed-fast) var(--transition-easing);
    }

    .date {
      color: var(--color-text-subtle);
      font-size: 0.75rem;
      font-weight: var(--font-weight-normal);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .keyboard-hint {
      color: var(--color-text-subtle);
      font-size: 0.7rem;
      margin-top: calc(var(--space) * 1.25);
      opacity: 0.6;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    .keyboard-hint kbd {
      background: transparent;
      padding: 0.2rem 0.45rem;
      border-radius: 0;
      border: 1px solid var(--color-text-subtle);
      font-family: inherit;
      font-size: 0.7rem;
    }

    .hint-group {
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .hint-separator {
      margin: 0 0.5rem;
    }
  </style>
  <div class="clock-container">
    <span class="greeting"></span>
    <time class="time"></time>
    <span class="date"></span>
    <div class="keyboard-hint">
      <span class="hint-group">
        <kbd>⌘</kbd>
        <kbd class="workspace-hint"></kbd>
        <span>switch workspace</span>
      </span>
      <span class="hint-separator">·</span>
      <span class="hint-group">
        <kbd>type</kbd>
        <span>search</span>
      </span>
    </div>
  </div>
</template>

<script type="module">
  class Clock extends HTMLElement {
    #greeting;
    #time;
    #date;
    #interval;
    #lastHours = -1;
    #lastMinutes = -1;
    #lastDate = '';
    #workspaceHint;

    constructor() {
      super();
      this.attachShadow({ mode: 'open' });
      this.#initializeTemplate();
      this.#updateWorkspaceHint();
      this.#updateClock();
      this.#interval = setInterval(() => this.#updateClock(), 1000);
    }

    disconnectedCallback() {
      if (this.#interval) clearInterval(this.#interval);
    }

    #initializeTemplate() {
      const template = document.getElementById('clock-template');
      const clone = template.content.cloneNode(true);
      this.#greeting = clone.querySelector('.greeting');
      this.#time = clone.querySelector('.time');
      this.#date = clone.querySelector('.date');
      this.#workspaceHint = clone.querySelector('.workspace-hint');
      this.shadowRoot.append(clone);
    }

    #updateWorkspaceHint() {
      if (this.#workspaceHint) {
        const count = workspaceManager.workspaces.length;
        if (count === 1) {
          this.#workspaceHint.textContent = '1';
        } else {
          this.#workspaceHint.textContent = `1-${count}`;
        }
      }
    }

    #updateClock() {
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes().toString().padStart(2, '0');
      const timeStr = `${hours}:${minutes}`;
      const greeting = this.#getGreeting(hours);
      const dateStr = now.toLocaleDateString('en-US', {
        weekday: 'long',
        month: 'long',
        day: 'numeric',
      });

      if (this.#lastHours !== hours || this.#lastMinutes !== minutes) {
        this.#time.textContent = timeStr;
        this.#greeting.textContent = greeting;
        this.#lastHours = hours;
        this.#lastMinutes = minutes;
      }

      if (this.#lastDate !== dateStr) {
        this.#date.textContent = dateStr;
        this.#lastDate = dateStr;
      }
    }

    #getGreeting(hours) {
      if (hours >= 5 && hours < 12) return 'Good morning';
      if (hours >= 12 && hours < 17) return 'Good afternoon';
      if (hours >= 17 && hours < 21) return 'Good evening';
      return 'Good night';
    }
  }

  customElements.define('clock-component', Clock);
</script>

<template id="tabs-template">
  <style>
    .tabs-container {
      display: flex;
      gap: 0;
      margin-bottom: calc(var(--space) * 1.5);
      background: transparent;
      border: 1px solid var(--color-focus);
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .tab {
      background: transparent;
      border: none;
      border-right: 1px solid var(--color-focus);
      color: var(--color-text-subtle);
      cursor: pointer;
      font-family: var(--font-family);
      font-size: 0.7rem;
      font-weight: var(--font-weight-normal);
      letter-spacing: 0.08em;
      padding: calc(var(--space) * 0.6) calc(var(--space) * 0.95);
      position: relative;
      text-transform: uppercase;
      transition: all var(--transition-speed) var(--transition-easing);
      outline: 0;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .tab:last-child {
      border-right: none;
    }

    .tab:hover {
      color: var(--color-text);
      background: var(--color-focus);
      opacity: 1;
    }

    .tab:focus {
      outline: 1px solid var(--color-accent);
      outline-offset: -2px;
      z-index: 1;
    }

    .tab:active {
      transform: scale(0.98);
      transition: transform var(--transition-speed-fast) var(--transition-easing);
    }

    .tab.active {
      color: var(--color-accent);
      background: var(--color-accent-glow);
    }

    .tab-key {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.2rem;
      height: 1.2rem;
      font-size: 0.6rem;
      font-weight: var(--font-weight-bold);
      background: transparent;
      border: 1px solid var(--color-text-subtle);
      border-radius: 0;
      opacity: 0.5;
      transition: all var(--transition-speed) var(--transition-easing);
    }

    .tab:hover .tab-key {
      opacity: 0.8;
      border-color: var(--color-text-subtle);
    }

    .tab.active .tab-key {
      opacity: 1;
      border-color: var(--color-accent);
    }

    @media (min-width: 600px) {
      .tab {
        font-size: 0.75rem;
        padding: calc(var(--space) * 0.6) calc(var(--space) * 1);
      }
    }
  </style>
  <nav class="tabs-container"></nav>
</template>

<template id="tab-template">
  <button class="tab" type="button">
    <span class="tab-key"></span>
    <span class="tab-name"></span>
  </button>
</template>

<script type="module">
  class Tabs extends HTMLElement {
    #tabsContainer;
    #tabTemplate;

    constructor() {
      super();
      this.attachShadow({ mode: 'open' });
      this.#initializeTemplate();
      this.#renderTabs();
      this.#initializeEventListeners();
    }

    #initializeTemplate() {
      const template = document.getElementById('tabs-template');
      const clone = template.content.cloneNode(true);
      this.#tabsContainer = clone.querySelector('.tabs-container');
      this.#tabTemplate = document.getElementById('tab-template');
      this.shadowRoot.append(clone);
    }

    #renderTabs() {
      const fragment = document.createDocumentFragment();
      const activeId = workspaceManager.activeWorkspaceId;

      workspaceManager.workspaces.forEach((workspace, index) => {
        const clone = this.#tabTemplate.content.cloneNode(true);
        const tab = clone.querySelector('.tab');
        const tabKey = clone.querySelector('.tab-key');
        const tabName = clone.querySelector('.tab-name');

        tab.dataset.workspaceId = workspace.id;
        tabKey.textContent = index + 1;
        tabName.textContent = workspace.name;

        if (workspace.id === activeId) {
          tab.classList.add('active');
        }

        fragment.appendChild(clone);
      });

      this.#tabsContainer.appendChild(fragment);
    }

    #initializeEventListeners() {
      this.#tabsContainer.addEventListener('click', (e) => {
        const tab = e.target.closest('.tab');
        if (!tab) return;

        const workspaceId = tab.dataset.workspaceId;
        this.switchToWorkspace(workspaceId);
      });

      this.#tabsContainer.addEventListener('keydown', (e) => {
        const tab = e.target.closest('.tab');
        if (!tab) return;

        const index = Array.from(this.#tabsContainer.children).indexOf(tab);
        if (e.key === 'ArrowLeft') {
          e.preventDefault();
          const prevTab = this.#tabsContainer.children[index - 1] || this.#tabsContainer.children[this.#tabsContainer.children.length - 1];
          if (prevTab) prevTab.focus();
        } else if (e.key === 'ArrowRight') {
          e.preventDefault();
          const nextTab = this.#tabsContainer.children[index + 1] || this.#tabsContainer.children[0];
          if (nextTab) nextTab.focus();
        }
      });

      window.addEventListener('workspacechange', (e) => {
        this.#updateActiveTab(e.detail.workspaceId);
      });
    }

    #updateActiveTab(workspaceId) {
      this.#tabsContainer.querySelectorAll('.tab').forEach((tab) => {
        tab.classList.toggle('active', tab.dataset.workspaceId === workspaceId);
      });
    }

    switchToWorkspace(workspaceId) {
      workspaceManager.switchTo(workspaceId);
    }
  }

  customElements.define('tabs-component', Tabs);
</script>

<template id="commands-template">
  <style>
    .commands {
      display: grid;
      gap: 0;
      list-style: none;
      margin: 0 auto;
      padding: 0;
      width: 100%;
      background: transparent;
      border: 1px solid var(--color-focus);
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .command {
      display: flex;
      gap: calc(var(--space) * 0.6);
      outline: 0;
      padding: calc(var(--space) * 0.8) calc(var(--space) * 1);
      position: relative;
      text-decoration: none;
      min-height: 48px;
      align-items: center;
      background: transparent;
      transition: all var(--transition-speed) var(--transition-easing);
      border-right: var(--grid-border);
      border-bottom: var(--grid-border);
    }

    .command:hover {
      color: var(--color-text);
      background: var(--color-focus);
      opacity: 1;
    }

    .command:focus {
      outline: 1px solid var(--color-accent);
      outline-offset: -1px;
      z-index: 1;
    }

    .command:active {
      transform: scale(0.98);
      transition: transform var(--transition-speed-fast) var(--transition-easing);
    }

    .key {
      color: var(--color-accent);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.8rem;
      height: 1.8rem;
      font-weight: var(--font-weight-bold);
      font-size: 0.8rem;
      letter-spacing: 0.04em;
      background: transparent;
      border: 1px solid var(--color-accent);
      border-radius: 0;
      flex-shrink: 0;
    }

    .name {
      color: var(--color-text-subtle);
      transition: color var(--transition-speed) var(--transition-easing);
      letter-spacing: 0.03em;
      font-size: 0.85rem;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .command:focus .name,
    .command:hover .name {
      color: var(--color-text);
    }

    @media (min-width: 900px) {
      .command {
        padding: calc(var(--space) * 0.9) calc(var(--space) * 1.1);
      }
    }
  </style>
  <nav>
    <menu class="commands"></menu>
  </nav>
</template>

<template id="command-template">
  <li>
    <a class="command" rel="noopener noreferrer">
      <span class="key"></span>
      <span class="name"></span>
    </a>
  </li>
</template>

<script type="module">
  class Commands extends HTMLElement {
    #activeWorkspaceId;
    #dynamicStyle;
    #sortedCommandsCache = null;
    #cachedWorkspaceId = null;

    constructor() {
      super();
      this.attachShadow({ mode: 'open' });
      this.#createDynamicStyle();
      this.#activeWorkspaceId = workspaceManager.activeWorkspaceId;
      this.render();
      this.#initializeEventListeners();
    }

    #createDynamicStyle() {
      this.#dynamicStyle = document.createElement('style');
      this.shadowRoot.appendChild(this.#dynamicStyle);
    }

    #calculateOptimalColumns(count, maxCols) {
      if (count <= 1) return 1;
      
      const minCols = 2;
      // Cap maxCols by count to avoid empty columns
      const effectiveMax = Math.min(maxCols, count);
      
      let bestCols = minCols;
      let minEmpty = Infinity;

      for (let c = minCols; c <= effectiveMax; c++) {
        const rows = Math.ceil(count / c);
        const empty = (rows * c) - count;
        
        // Minimize empty cells, tie-break with wider layout
        if (empty < minEmpty) {
          minEmpty = empty;
          bestCols = c;
        } else if (empty === minEmpty) {
          bestCols = c;
        }
      }
      
      return bestCols;
    }

    #generateGridCSS(cols) {
      return `
        .commands {
          grid-template-columns: repeat(${cols}, 1fr);
          max-width: ${cols * 12}rem;
        }
        .command:nth-child(${cols}n) {
          border-right: none;
        }
        .command:nth-last-child(-n + ${cols}) {
          border-bottom: none;
        }
      `;
    }

    #updateGridStyles(count) {
      const colsMobile = this.#calculateOptimalColumns(count, 3);
      const colsTablet = this.#calculateOptimalColumns(count, 4);
      const colsDesktop = this.#calculateOptimalColumns(count, 6);
      
      this.#dynamicStyle.textContent = `
        @media (max-width: 599px) {
          ${this.#generateGridCSS(colsMobile)}
        }
        @media (min-width: 600px) and (max-width: 899px) {
          ${this.#generateGridCSS(colsTablet)}
        }
        @media (min-width: 900px) {
          ${this.#generateGridCSS(colsDesktop)}
        }
      `;
    }

    #initializeEventListeners() {
      window.addEventListener('workspacechange', (e) => {
        this.#activeWorkspaceId = e.detail.workspaceId;
        this.#sortedCommandsCache = null; // Invalidate cache on workspace change
        this.rerender();
      });
    }

    render() {
      const template = document.getElementById('commands-template');
      const clone = template.content.cloneNode(true);
      const commandsContainer = clone.querySelector('.commands');
      const commandTemplate = document.getElementById('command-template');

      const fragment = this.createCommandsFragment(commandTemplate);
      const count = fragment.children.length;
      
      if (count === 0) {
        this.shadowRoot.append(clone);
        commandsContainer.style.display = 'none';
        return;
      }

      this.#updateGridStyles(count);
      commandsContainer.appendChild(fragment);
      this.shadowRoot.append(clone);
    }

    rerender() {
      const commandsContainer = this.shadowRoot.querySelector('.commands');
      if (!commandsContainer) return;

      const commandTemplate = document.getElementById('command-template');
      const fragment = this.createCommandsFragment(commandTemplate);
      const count = fragment.children.length;

      if (count === 0) {
        commandsContainer.style.display = 'none';
        return;
      }

      // Use replaceChildren for better performance than innerHTML
      commandsContainer.replaceChildren(fragment);
      this.#updateGridStyles(count);
      commandsContainer.style.display = 'grid';
    }

    #getSortedCommands(workspaceCommands) {
      // Use cache if available and workspace hasn't changed
      if (this.#sortedCommandsCache && this.#cachedWorkspaceId === this.#activeWorkspaceId) {
        return this.#sortedCommandsCache;
      }
      
      const sorted = Array.from(workspaceCommands.entries()).sort((a, b) => {
        const usageA = UsageTracker.getUsageCount(a[0]);
        const usageB = UsageTracker.getUsageCount(b[0]);
        return usageB - usageA;
      });
      
      // Update cache
      this.#sortedCommandsCache = sorted;
      this.#cachedWorkspaceId = this.#activeWorkspaceId;
      
      return sorted;
    }

    createCommandsFragment(commandTemplate) {
      const fragment = document.createDocumentFragment();
      const workspaceCommands = workspaceManager.getCommandsForWorkspace(this.#activeWorkspaceId);
      const sortedCommands = this.#getSortedCommands(workspaceCommands);
      
      for (const [key, { name, url }] of sortedCommands) {
        if (!name || !url) continue;
        const commandClone = this.createCommandElement(
          commandTemplate,
          key,
          name,
          url
        );
        fragment.appendChild(commandClone);
      }
      return fragment;
    }

    createCommandElement(template, key, name, url) {
      const clone = template.content.cloneNode(true);
      const command = clone.querySelector('.command');
      command.href = url;
      if (CONFIG.openLinksInNewTab) command.target = '_blank';
      command.addEventListener('click', () => {
        UsageTracker.recordUsage(key);
      });
      clone.querySelector('.key').innerText = key;
      clone.querySelector('.name').innerText = name;
      return clone;
    }
  }

  customElements.define('commands-component', Commands);
</script>

<template id="search-template">
  <style>
    input,
    button {
      appearance: none;
      background: transparent;
      border: 0;
      display: block;
      outline: 0;
    }

    .dialog {
      align-items: center;
      background: var(--color-background);
      border: none;
      display: none;
      flex-direction: column;
      height: 100%;
      justify-content: center;
      left: 0;
      padding: 0;
      top: 0;
      width: 100%;
    }

    .dialog[open] {
      display: flex;
    }

    .form {
      width: 100%;
    }

    .input {
      color: var(--color-text);
      font-size: clamp(1.6rem, 5vw, 2.5rem);
      font-weight: var(--font-weight-bold);
      padding: 0;
      text-align: center;
      width: 100%;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .input::placeholder {
      color: var(--color-text-subtle);
      opacity: 0.5;
    }

    .suggestions {
      align-items: center;
      display: flex;
      flex-direction: column;
      flex-wrap: wrap;
      justify-content: center;
      list-style: none;
      margin: calc(var(--space) * 0.75) 0 0;
      overflow: hidden;
      padding: 0;
      gap: 0.25rem;
    }

    .suggestion {
      color: var(--color-text);
      cursor: pointer;
      font-size: 0.75rem;
      padding: calc(var(--space) * 0.55) calc(var(--space) * 0.9);
      position: relative;
      transition: all var(--transition-speed) var(--transition-easing);
      white-space: nowrap;
      z-index: 1;
      border-radius: 0;
      outline: 0;
      background: transparent;
      border: 1px solid var(--color-focus);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .suggestion:focus,
    .suggestion:hover {
      color: var(--color-accent);
      border-color: var(--color-accent);
      opacity: 1;
    }

    .suggestion:focus {
      outline: 1px solid var(--color-accent);
      outline-offset: 2px;
    }

    .suggestion:active {
      transform: scale(0.98);
      transition: transform var(--transition-speed-fast) var(--transition-easing);
    }

    .match {
      color: var(--color-accent);
      transition: color var(--transition-speed) var(--transition-easing);
      font-weight: var(--font-weight-bold);
    }

    .suggestion:focus .match,
    .suggestion:hover .match {
      color: var(--color-accent);
    }

    @media (min-width: 700px) {
      .suggestions {
        flex-direction: row;
      }
    }
  </style>
  <dialog class="dialog">
    <form autocomplete="off" class="form" method="dialog" spellcheck="false">
      <input
        class="input"
        title="search"
        type="text"
        placeholder="Type to search..."
      />
      <menu class="suggestions"></menu>
    </form>
  </dialog>
</template>

<template id="suggestion-template">
  <li>
    <button class="suggestion" type="button"></button>
  </li>
</template>

<template id="match-template">
  <span class="match"></span>
</template>

<script type="module">
  class Search extends HTMLElement {
    #dialog;
    #form;
    #input;
    #suggestions;
    #suggestionTemplate;
    #matchTemplate;
    #debounceTimeout;
    #activeWorkspaceId;

    constructor() {
      super();
      this.attachShadow({ mode: 'open' });
      this.#activeWorkspaceId = workspaceManager.activeWorkspaceId;
      this.#initializeTemplate();
      this.#initializeEventListeners();
    }

    disconnectedCallback() {
      clearTimeout(this.#debounceTimeout);
    }

    #initializeTemplate() {
      const template = document.getElementById('search-template');
      const clone = template.content.cloneNode(true);
      this.#dialog = clone.querySelector('.dialog');
      this.#form = clone.querySelector('.form');
      this.#input = clone.querySelector('.input');
      this.#suggestions = clone.querySelector('.suggestions');
      this.#suggestionTemplate = document.getElementById('suggestion-template');
      this.#matchTemplate = document.getElementById('match-template');
      this.shadowRoot.append(clone);
    }

    #initializeEventListeners() {
      this.#form.addEventListener('submit', this.#onSubmit.bind(this), false);
      this.#input.addEventListener(
        'input',
        Search.#debounce(this.#onInput.bind(this), 300)
      );
      this.#suggestions.addEventListener(
        'click',
        this.#onSuggestionClick.bind(this)
      );
      document.addEventListener('keydown', this.#onKeydown.bind(this));
      window.addEventListener('workspacechange', (e) => {
        this.#activeWorkspaceId = e.detail.workspaceId;
      });
    }

    static #debounce(fn, delay) {
      let timeoutId;
      return function (...args) {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => fn.apply(this, args), delay);
      };
    }

    static #fetchDuckDuckGoSuggestions(search) {
      return new Promise((resolve) => {
        const callbackName = `ac_${Date.now()}`;
        window[callbackName] = (res) => {
          const suggestions = res
            .filter((item) => item.phrase !== search.toLowerCase())
            .map((item) => item.phrase);
          delete window[callbackName];
          resolve(suggestions);
        };

        const script = document.createElement('script');
        script.src = `https://duckduckgo.com/ac/?callback=${callbackName}&q=${encodeURIComponent(search)}`;
        script.onerror = () => {
          delete window[callbackName];
          resolve([]);
        };
        document.head.appendChild(script);
        script.onload = () => script.remove();
      });
    }

    static #formatSearchUrl(template, search) {
      return template.replace(/{}/g, encodeURIComponent(search));
    }

    static #hasProtocol(s) {
      return /^[a-zA-Z]+:\/\//i.test(s);
    }

    static #isUrl(s) {
      return /^((https?:\/\/)?[\w-]+(\.[\w-]+)+\.?(:\d+)?(\/\S*)?)$/i.test(s);
    }

    static #compareKey(key) {
      return CONFIG.commandCaseSensitive ? key : key.toLowerCase();
    }

    static #getCommandWithKey(key, workspaceCommands) {
      if (CONFIG.commandCaseSensitive) {
        const command = workspaceCommands.get(key);
        return command ? { command, key } : undefined;
      } else {
        const lowerKey = key.toLowerCase();
        for (const [cmdKey, value] of workspaceCommands) {
          if (cmdKey.toLowerCase() === lowerKey) {
            return { command: value, key: cmdKey };
          }
        }
        return undefined;
      }
    }

    #parseQuery(raw) {
      const workspaceCommands = workspaceManager.getCommandsForWorkspace(this.#activeWorkspaceId);
      const query = raw.trim();
      const compareQuery = Search.#compareKey(query);

      if (Search.#isUrl(query)) {
        const url = Search.#hasProtocol(query) ? query : `https://${query}`;
        return { query, url };
      }

      const result = Search.#getCommandWithKey(query, workspaceCommands);
      if (result) {
        return { key: result.key, query, url: result.command.url };
      }

      const [commandPart, searchPart] = query.split(
        new RegExp(`${CONFIG.commandSearchDelimiter}(.*)`)
      );
      const commandPartResult = Search.#getCommandWithKey(commandPart, workspaceCommands);
      if (commandPartResult) {
        const search = searchPart ? searchPart.trim() : '';
        const template = new URL(
          commandPartResult.command.searchTemplate ?? '',
          commandPartResult.command.url
        );
        const url = Search.#formatSearchUrl(decodeURI(template.href), search);
        return { key: commandPartResult.key, query, search, url };
      }

      const [pathKey, path] = query.split(
        new RegExp(`${CONFIG.commandPathDelimiter}(.*)`)
      );
      const pathKeyResult = Search.#getCommandWithKey(pathKey, workspaceCommands);
      if (pathKeyResult) {
        const url = `${new URL(pathKeyResult.command.url).origin}/${path || ''}`;
        return { key: pathKeyResult.key, path, query, url };
      }

      const url = Search.#formatSearchUrl(CONFIG.defaultSearchTemplate, query);
      return { query, search: query, url };
    }

    #close() {
      this.#input.value = '';
      this.#input.blur();
      
      // Fade-out animation
      this.#dialog.style.cssText = 'transition: opacity 0.1s ease; opacity: 0;';
      
      setTimeout(() => {
        this.#dialog.close();
        this.#suggestions.replaceChildren();
        this.#dialog.style.cssText = '';
      }, 100);
    }

    #execute(query) {
      const parsedQuery = this.#parseQuery(query);
      if (parsedQuery.key) {
        UsageTracker.recordUsage(parsedQuery.key);
      }
      const target = CONFIG.openLinksInNewTab ? '_blank' : '_self';
      window.open(parsedQuery.url, target, 'noopener noreferrer');
      this.#close();
    }

    #focusNextSuggestion(previous = false) {
      const active = this.shadowRoot.activeElement;
      let nextIndex;

      if (active.dataset.index) {
        const activeIndex = Number(active.dataset.index);
        nextIndex = previous ? activeIndex - 1 : activeIndex + 1;
      } else {
        nextIndex = previous ? this.#suggestions.childElementCount - 1 : 0;
      }

      const next = this.#suggestions.children[nextIndex];
      if (next) next.querySelector('.suggestion').focus();
      else this.#input.focus();
    }

    async #onInput() {
      const workspaceCommands = workspaceManager.getCommandsForWorkspace(this.#activeWorkspaceId);
      const parsedQuery = this.#parseQuery(this.#input.value);

      if (!parsedQuery.query) {
        this.#close();
        return;
      }

      const result = Search.#getCommandWithKey(parsedQuery.key || parsedQuery.query, workspaceCommands);
      let suggestions = result?.command?.suggestions ?? [];

      if (parsedQuery.search && suggestions.length < CONFIG.suggestionLimit) {
        const ddgSuggestions = await Search.#fetchDuckDuckGoSuggestions(
          parsedQuery.search
        );

        suggestions = suggestions.concat(
          parsedQuery.key
            ? ddgSuggestions.map(
                (s) => `${parsedQuery.key}${CONFIG.commandSearchDelimiter}${s}`
              )
            : ddgSuggestions
        );
      }

      const newParsedQuery = this.#parseQuery(this.#input.value);
      if (
        Search.#compareKey(newParsedQuery.query) !==
        Search.#compareKey(parsedQuery.query)
      )
        return;

      const filteredSuggestions = CONFIG.commandCaseSensitive
        ? suggestions
        : suggestions.filter((s) =>
            Search.#compareKey(s).startsWith(
              Search.#compareKey(parsedQuery.query)
            )
          );

      this.#renderSuggestions(filteredSuggestions, parsedQuery.query);
    }

    #onKeydown(e) {
      // Prevent Alt key (alone or with non-number keys) from activating search
      if (e.altKey && !/^[1-9]$/.test(e.key)) {
        return;
      }

      // Don't open search dialog when any modifier keys are pressed
      if (e.metaKey || e.ctrlKey || e.altKey) {
        return;
      }

      if (!this.#dialog.open) {
        this.#dialog.show();
        this.#input.focus();

        requestAnimationFrame(() => {
          if (!this.#input.value) this.#close();
        });

        return;
      }

      if (e.key === 'Escape') {
        this.#close();
        return;
      }

      const modifierPrefixedKey = this.#getModifierPrefixedKey(e);

      if (/^(ArrowDown|Tab|ctrl-n)$/.test(modifierPrefixedKey)) {
        e.preventDefault();
        this.#focusNextSuggestion();
        return;
      }

      if (/^(ArrowUp|ctrl-p|shift-Tab)$/.test(modifierPrefixedKey)) {
        e.preventDefault();
        this.#focusNextSuggestion(true);
      }
    }

    #getModifierPrefixedKey(e) {
      const alt = e.altKey ? 'alt-' : '';
      const ctrl = e.ctrlKey ? 'ctrl-' : '';
      const meta = e.metaKey ? 'meta-' : '';
      const shift = e.shiftKey ? 'shift-' : '';
      return `${alt}${ctrl}${meta}${shift}${e.key}`;
    }

    #onSubmit() {
      this.#execute(this.#input.value);
    }

    #onSuggestionClick(e) {
      const ref = e.target.closest('.suggestion');
      if (!ref) return;
      this.#execute(ref.dataset.suggestion);
    }

    #renderSuggestions(suggestions, query) {
      this.#suggestions.replaceChildren();

      const fragment = document.createDocumentFragment();
      suggestions
        .slice(0, CONFIG.suggestionLimit)
        .forEach((suggestion, index) => {
          const clone = this.#suggestionTemplate.content.cloneNode(true);
          const ref = clone.querySelector('.suggestion');
          ref.dataset.index = index;
          ref.dataset.suggestion = suggestion;

          const compareQuery = Search.#compareKey(query);
          const compareSuggestion = Search.#compareKey(suggestion);
          const matchIndex = compareSuggestion.indexOf(compareQuery);

          if (matchIndex !== -1) {
            const pre = suggestion.slice(0, matchIndex);
            const match = suggestion.slice(
              matchIndex,
              matchIndex + query.length
            );
            const post = suggestion.slice(matchIndex + query.length);

            const matchClone = this.#matchTemplate.content.cloneNode(true);
            const matchRef = matchClone.querySelector('.match');
            matchRef.textContent = match;

            ref.append(
              document.createTextNode(pre),
              matchClone,
              document.createTextNode(post)
            );
          } else {
            ref.textContent = suggestion;
          }

          fragment.appendChild(clone);
        });

      this.#suggestions.appendChild(fragment);
    }
  }

  customElements.define('search-component', Search);
</script>

<template id="news-template">
  <style>
    .news-container {
      margin-top: 0;
      max-width: 48rem;
      width: 100%;
    }

    .news-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: calc(var(--space) * 0.6);
      padding: 0 calc(var(--space) * 0.3);
    }

    .news-title {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      color: var(--color-text-subtle);
      text-decoration: none;
      font-size: 0.7rem;
      font-weight: var(--font-weight-bold);
      letter-spacing: 0.12em;
      text-transform: uppercase;
      transition: color var(--transition-speed) var(--transition-easing);
    }

    .news-title:hover {
      color: var(--color-text);
    }

    .news-title svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
      opacity: 0.7;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .cache-time {
      color: var(--color-text-subtle);
      font-size: 0.65rem;
      opacity: 0.6;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .refresh-btn {
      background: transparent;
      border: 1px solid var(--color-focus);
      color: var(--color-text-subtle);
      padding: 0.3rem;
      border-radius: 0;
      cursor: pointer;
      transition: all var(--transition-speed) var(--transition-easing);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .refresh-btn svg {
      width: 12px;
      height: 12px;
      fill: currentColor;
      transition: transform 0.5s var(--transition-easing);
    }

    .refresh-btn:hover {
      border-color: var(--color-text-subtle);
      color: var(--color-text);
    }

    .refresh-btn:hover svg {
      transform: rotate(180deg);
      transition: transform var(--transition-speed) var(--transition-easing);
    }

    .refresh-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .refresh-btn:disabled svg {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    .news-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0;
      background: transparent;
      border: 1px solid var(--color-focus);
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .news-item {
      display: grid;
      grid-template-columns: 2.5rem 1fr auto;
      align-items: center;
      gap: calc(var(--space) * 0.6);
      padding: calc(var(--space) * 0.6) calc(var(--space) * 0.85);
      background: transparent;
      transition: all var(--transition-speed) var(--transition-easing);
      text-decoration: none;
      color: inherit;
      outline: 0;
      border-bottom: 1px solid var(--color-focus);
    }

    .news-item:hover {
      color: var(--color-text);
      border-color: var(--color-text-subtle);
      opacity: 1;
    }

    .news-item:focus {
      outline: 1px solid var(--color-accent);
      outline-offset: -1px;
      z-index: 1;
    }

    .news-item:active {
      transform: scale(0.98);
      transition: transform var(--transition-speed-fast) var(--transition-easing);
    }

    .news-item:last-child {
      border-bottom: none;
    }

    .news-item-rank {
      color: var(--color-text-subtle);
      font-size: 0.75rem;
      font-weight: var(--font-weight-bold);
      font-variant-numeric: tabular-nums;
      text-align: center;
      opacity: 0.5;
    }

    .news-item-content {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      min-width: 0;
    }

    .news-item-title {
      color: var(--color-text);
      font-size: 0.82rem;
      font-weight: var(--font-weight-normal);
      line-height: 1.4;
      margin: 0;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .news-item-meta {
      display: flex;
      align-items: center;
      gap: 0.45rem;
      color: var(--color-text-subtle);
      font-size: 0.65rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    .news-item-domain {
      opacity: 0.7;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .meta-separator {
      opacity: 0.3;
    }

    .news-item-stats {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.2rem;
      flex-shrink: 0;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .score-badge {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      color: var(--color-accent);
      font-size: 0.7rem;
      font-weight: var(--font-weight-bold);
      font-variant-numeric: tabular-nums;
    }

    .score-badge svg {
      width: 9px;
      height: 9px;
      fill: currentColor;
    }

    .time-badge {
      color: var(--color-text-subtle);
      font-size: 0.65rem;
      opacity: 0.7;
    }

    .comments-link {
      display: flex;
      align-items: center;
      gap: 0.25rem;
      color: var(--color-text-subtle);
      font-size: 0.65rem;
      opacity: 0.7;
    }

    .comments-link svg {
      width: 9px;
      height: 9px;
      fill: currentColor;
    }

    .loading {
      text-align: center;
      color: var(--color-text-subtle);
      padding: calc(var(--space) * 1.4);
      font-size: 0.75rem;
      background: transparent;
      border-radius: var(--border-radius);
      border: 1px solid var(--color-focus);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .loading-spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 1px solid var(--color-focus);
      border-top-color: var(--color-accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 0.5rem;
      vertical-align: middle;
      transition: border-top-color var(--transition-speed) var(--transition-easing);
    }

    .error {
      text-align: center;
      color: var(--color-text-subtle);
      padding: var(--space);
      font-size: 0.75rem;
      opacity: 0.7;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .retry-btn {
      background: transparent;
      border: 1px solid var(--color-text-subtle);
      color: var(--color-text-subtle);
      padding: 0.2rem 0.65rem;
      border-radius: 0;
      margin-left: 0.5rem;
      cursor: pointer;
      font-size: 0.7rem;
      transition: all var(--transition-speed) var(--transition-easing);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .retry-btn:hover {
      border-color: var(--color-text);
      color: var(--color-text);
    }

    @media (min-width: 700px) {
      .news-item {
        grid-template-columns: 2.5rem 1fr auto;
        padding: calc(var(--space) * 0.7) calc(var(--space) * 1);
      }

      .news-item-title {
        font-size: 0.85rem;
        -webkit-line-clamp: 1;
      }

      .news-item-stats {
        flex-direction: row;
        gap: var(--space);
      }
    }
  </style>
  <div class="news-container">
    <div class="news-header">
      <a
        href="https://news.ycombinator.com"
        target="_blank"
        rel="noopener noreferrer"
        class="news-title"
      >
        <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M0 0v16h16V0H0zm8.8 9.6V14H7.2V9.6L3.6 2h1.8l3.6 6 3.6-6h1.8L8.8 9.6z"
          />
        </svg>
        Hacker News
      </a>
      <div class="header-actions">
        <span class="cache-time"></span>
        <button class="refresh-btn" type="button" title="Refresh stories">
          <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M13.65 2.35A8 8 0 1 0 16 8h-2a6 6 0 1 1-1.76-4.24L10 6h6V0l-2.35 2.35z"
            />
          </svg>
        </button>
      </div>
    </div>
    <ul class="news-list"></ul>
    <div class="loading">
      <span class="loading-spinner"></span>
      Loading stories...
    </div>
  </div>
</template>

<template id="news-item-template">
  <li>
    <a class="news-item" target="_blank" rel="noopener noreferrer">
      <span class="news-item-rank"></span>
      <div class="news-item-content">
        <h3 class="news-item-title"></h3>
        <div class="news-item-meta">
          <span class="news-item-domain"></span>
          <span class="meta-separator">·</span>
          <span class="comments-link">
            <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
              <path
                d="M14 1H2a2 2 0 0 0-2 2v8a2 2 0 0 0 2 2h3l3 3 3-3h3a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2z"
              />
            </svg>
            <span class="comments-count"></span>
          </span>
        </div>
      </div>
      <div class="news-item-stats">
        <div class="score-badge">
          <svg viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
            <path
              d="M8 0l2.5 5 5.5.8-4 3.9.9 5.5L8 12.5l-4.9 2.7.9-5.5-4-3.9L5.5 5z"
            />
          </svg>
          <span class="score"></span>
        </div>
        <span class="time-badge"></span>
      </div>
    </a>
  </li>
</template>

<script type="module">
  class NewsFeed extends HTMLElement {
    static #newsItemTemplate = null;

    #container;
    #newsList;
    #loading;
    #refreshBtn;
    #cacheTime;
    #stories = [];
    #CACHE_KEY = 'hacker-news-stories';
    #CACHE_DURATION = 30 * 60 * 1000; // 30 minutes

    constructor() {
      super();
      this.attachShadow({ mode: 'open' });
      this.#initializeTemplate();
      this.#initializeEventListeners();
      this.#loadStories();
    }

    #initializeTemplate() {
      const template = document.getElementById('news-template');
      const clone = template.content.cloneNode(true);
      this.#container = clone.querySelector('.news-container');
      this.#newsList = clone.querySelector('.news-list');
      this.#loading = clone.querySelector('.loading');
      this.#refreshBtn = clone.querySelector('.refresh-btn');
      this.#cacheTime = clone.querySelector('.cache-time');

      if (!NewsFeed.#newsItemTemplate) {
        NewsFeed.#newsItemTemplate =
          document.getElementById('news-item-template');
      }

      this.shadowRoot.append(clone);
    }

    #initializeEventListeners() {
      this.#refreshBtn.addEventListener('click', () => {
        this.#loadStories(true);
      });
    }

    #isCacheValid() {
      try {
        const cached = localStorage.getItem(this.#CACHE_KEY);
        if (!cached) return false;

        const { timestamp } = JSON.parse(cached);
        return Date.now() - timestamp < this.#CACHE_DURATION;
      } catch {
        return false;
      }
    }

    #getCachedStories() {
      try {
        const cached = localStorage.getItem(this.#CACHE_KEY);
        return JSON.parse(cached);
      } catch {
        return null;
      }
    }

    #updateCacheTimeDisplay() {
      try {
        const cached = localStorage.getItem(this.#CACHE_KEY);
        if (cached) {
          const { timestamp } = JSON.parse(cached);
          const minutes = Math.floor((Date.now() - timestamp) / 60000);
          if (minutes < 1) {
            this.#cacheTime.textContent = 'just now';
          } else if (minutes === 1) {
            this.#cacheTime.textContent = '1m ago';
          } else {
            this.#cacheTime.textContent = `${minutes}m ago`;
          }
        }
      } catch {
        this.#cacheTime.textContent = '';
      }
    }

    #setCachedStories(stories) {
      try {
        const cacheData = {
          stories,
          timestamp: Date.now(),
        };
        localStorage.setItem(this.#CACHE_KEY, JSON.stringify(cacheData));
      } catch (error) {
        console.warn('Failed to cache stories:', error);
      }
    }

    async #loadStories(forceRefresh = false) {
      this.#refreshBtn.disabled = true;
      this.#loading.style.display = 'block';
      this.#newsList.style.display = 'none';

      try {
        // Check if we have valid cached stories
        if (!forceRefresh && this.#isCacheValid()) {
          const cached = this.#getCachedStories();
          if (cached && cached.stories && cached.stories.length > 0) {
            this.#stories = cached.stories;
            this.#renderStories();
            this.#updateCacheTimeDisplay();
            this.#loading.style.display = 'none';
            this.#newsList.style.display = 'flex';
            this.#refreshBtn.disabled = false;
            return;
          }
        }

        // Fetch fresh stories
        this.#stories = await HackerNewsAPI.fetchTopStories(10);
        this.#setCachedStories(this.#stories);
        this.#renderStories();
        this.#updateCacheTimeDisplay();
        this.#loading.style.display = 'none';
        this.#newsList.style.display = 'flex';
      } catch (error) {
        console.error('Failed to load stories:', error);

        // Try to show cached stories even if expired
        const cached = this.#getCachedStories();
        if (cached && cached.stories && cached.stories.length > 0) {
          this.#stories = cached.stories;
          this.#renderStories();
          this.#loading.textContent = 'Showing cached stories (offline)';
          this.#loading.className = 'error';
        } else {
          this.#loading.innerHTML =
            'Failed to load stories <button class="retry-btn">Retry</button>';
          this.#loading.className = 'error';
          const retryBtn = this.#loading.querySelector('.retry-btn');
          if (retryBtn) {
            retryBtn.addEventListener('click', () => {
              this.#loadStories(true);
            });
          }
        }
      } finally {
        this.#refreshBtn.disabled = false;
      }
    }

    #renderStories() {
      const fragment = document.createDocumentFragment();

      this.#stories.forEach((story, index) => {
        const clone = NewsFeed.#newsItemTemplate.content.cloneNode(true);
        const newsItem = clone.querySelector('.news-item');
        const rank = clone.querySelector('.news-item-rank');
        const title = clone.querySelector('.news-item-title');
        const domain = clone.querySelector('.news-item-domain');
        const score = clone.querySelector('.score');
        const time = clone.querySelector('.time-badge');
        const commentsCount = clone.querySelector('.comments-count');

        newsItem.href =
          story.url || `https://news.ycombinator.com/item?id=${story.id}`;
        rank.textContent = `${index + 1}`;
        title.textContent = story.title;

        if (story.url) {
          try {
            const url = new URL(story.url);
            domain.textContent = url.hostname.replace(/^www\./, '');
          } catch {
            domain.textContent = '';
          }
        } else {
          domain.textContent = 'news.ycombinator.com';
        }

        score.textContent = HackerNewsAPI.formatScore(story.score || 0);
        time.textContent = HackerNewsAPI.formatTime(story.time || 0);
        commentsCount.textContent = story.descendants || 0;

        fragment.appendChild(clone);
      });

      this.#newsList.replaceChildren(fragment);
    }
  }

  customElements.define('news-feed-component', NewsFeed);
</script>

<style>
  /* Global Styles */
  html {
    background-color: var(--color-background);
    font-family: var(--font-family);
    font-size: var(--font-size);
    line-height: 1.4;
    letter-spacing: var(--letter-spacing);
    overflow-x: hidden;
    scrollbar-width: none; /* Firefox */
  }

  html::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Edge */
  }

  body {
    margin: 0;
    overflow-x: hidden;
    scrollbar-width: none; /* Firefox */
    background-color: var(--color-background);
    background-image: repeating-linear-gradient(
      to bottom,
      transparent 0,
      transparent 2px,
      var(--color-scanline) 2px,
      var(--color-scanline) 3px
    );
  }

  body::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Edge */
  }

  /* Main Container Styles */
  main {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    box-sizing: border-box;
    min-height: 100dvh;
    width: 100vw;
    padding: calc(var(--space) * 4) var(--space) calc(var(--space) * 3);
    overflow: hidden;
    position: relative;
    opacity: 0;
    animation: fadeIn 0.5s var(--transition-easing) forwards;
    scrollbar-width: none; /* Firefox */
    transition: background-color var(--transition-speed) var(--transition-easing);
  }

  main::-webkit-scrollbar {
    display: none; /* Chrome, Safari, Edge */
  }

  .main-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex: 1;
    width: 100%;
    max-width: 48rem;
    gap: calc(var(--space) * 1.5);
  }

  /* News Section Styles */
  .news-section {
    display: flex;
    justify-content: center;
    width: 100%;
    padding: 0 var(--space) calc(var(--space) * 3);
    margin-top: calc(var(--space) * 2);
  }

  @keyframes fadeIn {
    to {
      opacity: 1;
    }
  }
</style>

<main>
  <div class="main-content">
    <tabs-component></tabs-component>
    <clock-component></clock-component>
    <commands-component></commands-component>
    <search-component></search-component>
  </div>
</main>

<section class="news-section">
  <news-feed-component></news-feed-component>
</section>
